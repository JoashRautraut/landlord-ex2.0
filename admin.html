<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - LandLord</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body>
    <!-- Header with top navbar -->
    <div class="admin-header">
      <div class="admin-header-inner">
        <div class="brand" style="margin-left:6px;">
          <img src="dar_logo.png" alt="DAR logo" class="brand-logo" style="margin:0;">
          <div class="brand-text">
            <div class="brand-title">LANDLORD Admin</div>
            <div class="brand-sub">Operations dashboard</div>
          </div>
        </div>
        <div class="header-actions" style="position:relative;">
          <button id="admin-settings-btn" aria-label="Settings" title="Settings" class="settings-btn">‚öôÔ∏è</button>
          <div id="admin-settings-menu" class="settings-menu" style="display:none;">
            <button id="admin-logout" class="settings-item danger">Log out</button>
          </div>
        </div>
      </div>
      <div class="admin-subnav">
        <a href="#profile" data-target="profile" class="subnav-link active" onclick="navigateTo('profile'); return false;">User Management</a>
        <a href="#workspace" data-target="workspace" class="subnav-link" onclick="navigateTo('workspace'); return false;">Activity Logs</a>
      </div>
    </div>
    <style>
      :root { --bg: linear-gradient(135deg, #202124 0%, #23272f 100%); --fg:#e4e6eb; --muted:#a6b0a9; --surface:#1e2024; --border:#2a3138; --accent:#f97316; --accent-strong:#ea580c; --accent-weak:#3a2a22; --accent-gradient: linear-gradient(135deg, #ff7a18 0%, #ff3f00 100%); }
      html, body { background: radial-gradient(1200px 500px at 70% -10%, rgba(255,122,24,0.18), transparent 60%), var(--bg); color: var(--fg); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; }

      .admin-header { position: sticky; top: 0; z-index: 3100; background: var(--surface); border-bottom: 1px solid var(--border); }
      .admin-header-inner { width: 100%; margin: 0; padding: 8px 12px; display:flex; align-items:center; justify-content: space-between; }
      .brand { display:flex; align-items:center; gap: 10px; }
      .brand-logo { width: 42px; height: 42px; border-radius: 8px; background:#fff; padding:4px; border:1px solid var(--border); }
      .brand-text { color: var(--fg); line-height:1.15; }
      .brand-title { font-weight:800; letter-spacing:.2px; background: var(--accent-gradient); -webkit-background-clip: text; background-clip: text; color: transparent; }
      .brand-sub { font-size:.85rem; color: var(--muted); }
      .settings-btn { width: 36px; height: 36px; border-radius: 8px; border: 1px solid var(--border); background: var(--surface); color: var(--fg); cursor:pointer; font-size: 18px; transition: background .15s ease, border-color .15s ease, color .15s ease; }
      .settings-btn:hover { background: #fff; border-color: var(--accent); color: var(--accent-strong); }
      .settings-menu { position:absolute; right:0; top:42px; min-width:180px; background:var(--surface); border:1px solid var(--border); border-radius:10px; box-shadow: 0 8px 24px rgba(15,23,42,.08); padding:6px; z-index:3200; }
      .settings-item { width:100%; text-align:left; background:none; border:none; padding:10px 12px; border-radius:8px; cursor:pointer; font-weight:600; color:var(--fg); transition: background .15s ease, color .15s ease; }
      .settings-item:hover { background: var(--accent-weak); color: var(--accent-strong); }
      .settings-item.danger { color:#b91c1c; font-weight:700; }

      .admin-subnav { background: var(--surface); border-top: 1px solid var(--border); position: sticky; top: 54px; z-index: 900; }
      .admin-subnav { display:flex; gap: 20px; padding: 10px 16px; justify-content: center; }
      .subnav-link { font-weight:700; font-size:.9rem; color:#334155; text-decoration:none; padding:8px 12px; border-radius:8px; transition: color .15s ease, background .15s ease, box-shadow .15s ease; }
      .subnav-link:hover { color: var(--accent-strong); background: #fff7ed; }
      .subnav-link:focus-visible { outline: 2px solid transparent; box-shadow: 0 0 0 3px rgba(249, 115, 22, .35); }
      .subnav-link.active { color: var(--accent-strong); background-image: linear-gradient( to right, rgba(255,122,24,.15), rgba(255,77,0,.12) ); }

      /* Admin content spacing */
      main.container { padding: 20px 16px; }
      /* Tables inspired by index.html dark theme */
      .account-table, .activity-log-table { background: rgba(35,39,47,0.98); color: #e4e6eb; border: 1.5px solid #23272f; box-shadow: 0 1px 4px rgba(0,0,0,0.07); border-radius: 8px; overflow: hidden; }
      .account-table th, .activity-log-table th, .account-table td, .activity-log-table td { padding: 14px 18px; text-align: left; border-bottom: 1px solid #292b32; vertical-align: middle; background: transparent; }
      .account-table th, .activity-log-table th { background: rgba(35,39,47,0.98); color: #ff7a18; font-size: 1em; font-weight: 700; border-bottom: 1.5px solid #292b32; }
      .account-table tr:last-child td, .activity-log-table tr:last-child td { border-bottom: none; }

      /* Inputs and buttons (modals) */
      #edit-user-modal .modal-content, #add-technician-modal .modal-content { border: 1px solid var(--border); background: var(--surface); }
      input[type="text"], input[type="email"], select { border: 1px solid var(--border); border-radius: 8px; padding: 10px 12px; background: #fff; color: var(--fg); transition: border-color .15s ease, box-shadow .15s ease; }
      input[type="text"]:hover, input[type="email"]:hover, select:hover { border-color: #f59e0b; }
      input[type="text"]:focus, input[type="email"]:focus, select:focus { outline: 2px solid transparent; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(249, 115, 22, .25); }
      .modal-btn { border: 1px solid var(--border); background: var(--surface); color: var(--fg); border-radius: 10px; padding: 10px 14px; font-weight: 700; transition: background .15s ease, border-color .15s ease, color .15s ease, box-shadow .15s ease; }
      .modal-btn.save, .add-tech-save-btn { background: var(--accent-gradient); color: #fff; border-color: transparent; }
      .modal-btn.save:hover, .add-tech-save-btn:hover { filter: saturate(1.05) brightness(1.02); box-shadow: 0 6px 18px rgba(255, 122, 24, .28); }
      .modal-btn.cancel, .add-tech-cancel-btn { background: #fff; }
      .modal-btn:hover { border-color: var(--accent); color: var(--accent-strong); }
      .modal-btn:focus-visible { outline: 2px solid transparent; box-shadow: 0 0 0 3px rgba(249, 115, 22, .35); }

      /* Table hovers aligned to dark theme */
      .account-table tbody tr:hover, .activity-log-table tbody tr:hover { background: #292b32; color: #ffd7c2; }
      
      /* Logout Confirmation Modal */
      .logout-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: 2500;
        display: none;
        display: grid;
        place-items: center;
        animation: fadeIn 0.3s ease-out;
      }

      .logout-modal.show {
        display: flex;
      }

      .logout-modal-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
      }

      /* Blur the background content when logout modal is open */
      body.logout-modal-open {
        overflow: hidden;
      }

      body.logout-modal-open > *:not(#logout-confirmation) {
        filter: blur(3px);
        transition: filter 0.3s ease;
      }

      body.logout-modal-open #logout-confirmation {
        filter: none;
      }

      .logout-modal-content {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(135deg, #ff7a18 0%, #ff3f00 100%);
        color: #ffffff;
        padding: 24px;
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.2);
        min-width: 320px;
        max-width: 400px;
        width: 90%;
        animation: modalSlideIn 0.3s ease-out;
      }

      .logout-modal-header h3 {
        margin: 0 0 8px 0;
        font-size: 1.25rem;
        font-weight: 800;
        letter-spacing: 0.2px;
      }

      .logout-modal-header p {
        margin: 0 0 20px 0;
        opacity: 0.95;
        font-size: 0.95rem;
        line-height: 1.4;
      }

      .logout-modal-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
      }

      .logout-btn {
        padding: 10px 16px;
        border: none;
        border-radius: 10px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.9rem;
        min-width: 80px;
      }

      .logout-btn-cancel {
        background: #ffffff;
        color: #1f2937;
      }

      .logout-btn-cancel:hover {
        background: #f3f4f6;
        transform: translateY(-1px);
      }

      .logout-btn-confirm {
        background: #1f2937;
        color: #ffffff;
      }

      .logout-btn-confirm:hover {
        background: #111827;
        transform: translateY(-1px);
      }

      /* Mobile responsive logout modal */
      @media (max-width: 480px) {
        .logout-modal-content {
          padding: 20px;
          min-width: 280px;
        }
        
        .logout-modal-actions {
          flex-direction: column;
          gap: 8px;
        }
        
        .logout-btn {
          width: 100%;
          padding: 12px 16px;
          font-size: 1rem;
        }
      }

      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }

      @keyframes modalSlideIn {
        from {
          transform: scale(0.95) translateY(10px);
          opacity: 0;
        }
        to {
          transform: scale(1) translateY(0);
          opacity: 1;
        }
      }
    </style>

    <!-- Dummy map container to satisfy shared scripts that may call navigateTo('map') -->
    <main id="map" class="container" style="display:none;"></main>

    <!-- User Management -->
    <main id="profile" class="container">
        <!-- Header Section -->
        <div class="user-management-header">
            <div class="header-content">
                <h2 class="section-title">
                    <span class="title-icon">üë•</span>
                    User Management
                </h2>
                <p class="section-subtitle">Manage system users, roles, and permissions</p>
            </div>
            <div class="header-actions">
                <button id="add-technician-btn" class="add-user-btn">
                    <span class="btn-icon">+</span>
                    <span class="btn-text">Add User</span>
                </button>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="user-stats-grid">
            <div class="stat-card">
                <div class="stat-icon active-users">üë§</div>
                <div class="stat-content">
                    <div class="stat-value" id="active-users-count">0</div>
                    <div class="stat-label">Active Users</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon total-users">üë•</div>
                <div class="stat-content">
                    <div class="stat-value" id="total-users-count">0</div>
                    <div class="stat-label">Total Users</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon technician-users">üîß</div>
                <div class="stat-content">
                    <div class="stat-value" id="technician-users-count">0</div>
                    <div class="stat-label">Technicians</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon office-users">üè¢</div>
                <div class="stat-content">
                    <div class="stat-value" id="office-users-count">0</div>
                    <div class="stat-label">Office Users</div>
                </div>
            </div>
        </div>

        <!-- Search and Filter Section -->
        <div class="search-filter-section">
            <div class="search-container">
                <div class="search-input-wrapper">
                    <input type="text" id="user-search" class="search-input" placeholder="Search users by name or email...">
                    <span class="search-icon">üîç</span>
                </div>
            </div>
            <div class="filter-container">
                <select id="role-filter" class="filter-select">
                    <option value="">All Roles</option>
                    <option value="technician">Technician</option>
                    <option value="office">Office</option>
                </select>
                <select id="status-filter" class="filter-select">
                    <option value="">All Status</option>
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                    <option value="suspended">Suspended</option>
                </select>
            </div>
        </div>

        <!-- Users Table -->
        <div class="users-table-container">
            <div class="table-header">
                <h3 class="table-title">System Users</h3>
                <div class="table-actions">
                    <button class="table-action-btn export-btn">
                        <span class="btn-icon">üìä</span>
                        Export
                    </button>
                    <button class="table-action-btn refresh-btn" id="refresh-users">
                        <span class="btn-icon">üîÑ</span>
                        Refresh
                    </button>
                </div>
            </div>
            
            <div class="table-wrapper">
                <table class="modern-users-table">
                <thead>
                    <tr>
                            <th class="sortable" data-sort="avatar">
                                <span class="th-content">
                                    <span class="th-text">User</span>
                                    <span class="sort-indicator">‚Üï</span>
                                </span>
                            </th>
                            <th class="sortable" data-sort="role">
                                <span class="th-content">
                                    <span class="th-text">Role</span>
                                    <span class="sort-indicator">‚Üï</span>
                                </span>
                            </th>
                            <th class="sortable" data-sort="status">
                                <span class="th-content">
                                    <span class="th-text">Status</span>
                                    <span class="sort-indicator">‚Üï</span>
                                </span>
                            </th>
                            <th class="sortable" data-sort="last-active">
                                <span class="th-content">
                                    <span class="th-text">Last Active</span>
                                    <span class="sort-indicator">‚Üï</span>
                                </span>
                            </th>
                            <th class="no-sort">
                                <span class="th-content">
                                    <span class="th-text">Actions</span>
                                </span>
                            </th>
                    </tr>
                </thead>
                    <tbody id="users-table-body">
                    <!-- User rows populated by JavaScript -->
                </tbody>
            </table>
            </div>
            
            <!-- Empty State -->
            <div class="empty-state" id="users-empty-state" style="display: none;">
                <div class="empty-icon">üë§</div>
                <h3 class="empty-title">No Users Found</h3>
                <p class="empty-message">No users match your current search criteria. Try adjusting your filters or search terms.</p>
                <button class="empty-action-btn" onclick="document.getElementById('user-search').value = ''; document.getElementById('role-filter').value = ''; document.getElementById('status-filter').value = ''; filterUsers();">
                    Clear Filters
                </button>
            </div>
        </div>

        <!-- Loading State -->
        <div class="loading-overlay" id="users-loading" style="display: none;">
            <div class="loading-spinner"></div>
            <p class="loading-text">Loading users...</p>
        </div>
    </main>

    <!-- Activity Logs -->
    <main id="workspace" class="container section" style="display: none;">
        <table class="activity-log-table">
            <thead>
                <tr>
                    <th>Operation name</th>
                    <th>Status</th>
                    <th>Time</th>
                    <th>Time stamp</th>
                </tr>
            </thead>
            <tbody>
                <!-- Activity log rows populated by JavaScript -->
            </tbody>
        </table>
    </main>

    <!-- Enhanced Edit User Modal -->
    <div id="edit-user-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Edit User Account</h2>
          <button id="close-edit-modal" class="close-btn" aria-label="Close modal">&times;</button>
        </div>
        
        <div class="modal-body">
          <div class="form-group">
            <label for="edit-user-firstname">First Name</label>
            <input id="edit-user-firstname" type="text" placeholder="Enter first name" />
          </div>
          
          <div class="form-group">
            <label for="edit-user-lastname">Last Name</label>
            <input id="edit-user-lastname" type="text" placeholder="Enter last name" />
          </div>
          
          <div class="form-group">
            <label for="edit-user-email">Email Address</label>
            <input id="edit-user-email" type="email" placeholder="Enter email address" />
          </div>
          
          <input type="hidden" id="edit-user-id" />
        </div>
        
        <div class="modal-footer">
          <button class="modal-btn cancel">Cancel</button>
          <button class="modal-btn save">Save Changes</button>
        </div>
      </div>
    </div>

    <!-- Enhanced Add Technician Modal -->
    <div id="add-technician-modal">
      <div class="modal-content">
        
        <h2 class="modal-title">Add New Technician</h2>
        <button id="close-add-technician-modal" class="modal-close-btn" aria-label="Close modal">&times;</button>
        
        <div>
          <label for="add-tech-firstname">First Name</label>
          <input id="add-tech-firstname" type="text" class="modal-input" placeholder="Enter first name" />
          
          <label for="add-tech-lastname">Last Name</label>
          <input id="add-tech-lastname" type="text" class="modal-input" placeholder="Enter last name" />
          
          <label for="add-tech-email">Email Address</label>
          <input id="add-tech-email" type="email" class="modal-input" placeholder="Enter email address" />

          <label for="add-tech-role">Role</label>
          <select id="add-tech-role" class="modal-input">
            <option value="technician" selected>Technician</option>
            <option value="office">Office</option>
          </select>
          
          <div style="display: flex; gap: 12px; margin-top: 20px;">
            <button class="modal-btn cancel add-tech-cancel-btn" id="cancel-add-technician">Cancel</button>
            <button class="modal-btn save add-tech-save-btn" id="save-add-technician">Add</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Logout Confirmation Modal -->
    <div id="logout-confirmation" class="logout-modal" style="display: none;">
      <div class="logout-modal-overlay"></div>
      <div class="logout-modal-content">
        <div class="logout-modal-header">
          <h3>Confirm Logout</h3>
          <p>Are you sure you want to log out of your account? You will need to sign in again to access the system.</p>
        </div>
        <div class="logout-modal-actions">
          <button id="logout-no" class="logout-btn logout-btn-cancel">Cancel</button>
          <button id="logout-yes" class="logout-btn logout-btn-confirm">Log out</button>
        </div>
      </div>
    </div>

    <!-- Simple navigation logic -->
    <script>
    function closeSidebar() {}
    // Simple section switcher for this page
    function navigateTo(sectionId) {
      document.querySelectorAll('main.container').forEach(function(section){ section.style.display = 'none'; });
      var el = document.getElementById(sectionId);
      if (el) el.style.display = 'block';
    }
    
    // Logout functions with blur effect
    function showLogoutConfirmation() {
      const modal = document.getElementById('logout-confirmation');
      if (modal) {
        modal.classList.add('show');
        modal.style.display = 'flex';
        document.body.classList.add('logout-modal-open');
      }
    }
    
    function hideLogoutConfirmation() {
      const modal = document.getElementById('logout-confirmation');
      if (modal) {
        modal.classList.remove('show');
        modal.style.display = 'none';
        document.body.classList.remove('logout-modal-open');
      }
    }
    // Settings dropdown and logout
    document.addEventListener('DOMContentLoaded', function(){
      var btn = document.getElementById('admin-settings-btn');
      var menu = document.getElementById('admin-settings-menu');
      if (btn && menu) {
        btn.addEventListener('click', function(e){
          e.stopPropagation();
          menu.style.display = (menu.style.display === 'none' || !menu.style.display) ? 'block' : 'none';
        });
        document.addEventListener('click', function(e){
          if (menu.style.display === 'block' && !menu.contains(e.target) && e.target !== btn) {
            menu.style.display = 'none';
          }
        });
      }
      var logoutBtn = document.getElementById('admin-logout');
      if (logoutBtn) logoutBtn.onclick = function(){ showLogoutConfirmation(); };
      
      // Wire logout modal buttons
      const logoutYes = document.getElementById('logout-yes');
      const logoutNo = document.getElementById('logout-no');
      if (logoutYes) logoutYes.onclick = function(){
        hideLogoutConfirmation();
        if (window.llLogout) { window.llLogout(); }
        else { try { localStorage.removeItem('ll_current_user'); } catch {}; window.location.href = 'index.html'; }
      };
      if (logoutNo) logoutNo.onclick = function(){ 
        hideLogoutConfirmation();
      };
      
      // Close logout modal when clicking on overlay
      const logoutModal = document.getElementById('logout-confirmation');
      if (logoutModal) {
        logoutModal.addEventListener('click', function(e) {
          if (e.target === logoutModal || e.target.classList.contains('logout-modal-overlay')) {
            hideLogoutConfirmation();
          }
        });
      }
    });
    // Hash navigation support
    document.addEventListener('DOMContentLoaded', function() {
      var hash = window.location.hash.replace('#', '');
      if (hash && document.getElementById(hash)) { navigateTo(hash); }
      else { navigateTo('profile'); }
      // Set active tab
      var links = document.querySelectorAll('.subnav-link');
      function setActive(id){ links.forEach(function(a){ a.classList.toggle('active', a.getAttribute('data-target')===id); }); }
      setActive(hash || 'profile');
      links.forEach(function(a){ a.addEventListener('click', function(){ setActive(a.getAttribute('data-target')); }); });
    });
    </script>

    <!-- Enhanced User Management JavaScript -->
    <script>
    // Backed by Supabase
    let sampleUsers = [];
    let currentUsers = [];
    let currentSort = { field: null, direction: 'asc' };

    // Initialize user management when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        initializeUserManagement();
        setupEventListeners();
    });

    async function initializeUserManagement() {
        await fetchUsersFromDB();
        updateUserStats();
        renderUsersTable();
    }

    async function waitForSupabaseClient(timeoutMs = 5000) {
        const start = Date.now();
        while (Date.now() - start < timeoutMs) {
            if (window.supabaseClient) return window.supabaseClient;
            await new Promise(r => setTimeout(r, 100));
        }
        return null;
    }

    async function fetchUsersFromDB() {
        try {
            let supa = window.supabaseClient || null;
            if (!supa) supa = await waitForSupabaseClient(5000);
            if (!supa && typeof window.getUsers === 'function') {
                const legacy = await window.getUsers();
                sampleUsers = (legacy || []).map(u => ({
                    id: u.user_id,
                    name: `${u.user_firstname || ''} ${u.user_lastname || ''}`.trim() || (u.user_email || 'User'),
                    email: u.user_email || '',
                    role: (u.role || 'user').toLowerCase(),
                    status: u.active === false ? 'suspended' : 'active',
                    lastActive: u.updated_at || u.created_at || new Date().toISOString(),
                    avatar: u.user_avatar_url || 'https://randomuser.me/api/portraits/lego/1.jpg'
                }));
                currentUsers = [...sampleUsers];
                return;
            }
            if (!supa) {
                console.warn('Supabase client not found after waiting');
                sampleUsers = [];
                currentUsers = [];
                return;
            }
            const { data, error } = await supa
                .from('users')
                .select('user_id, user_firstname, user_lastname, user_email, role, active, username')
                .order('user_id', { ascending: true });
            if (error) { console.error(error); return; }
            sampleUsers = (data || []).map(u => ({
                id: u.user_id,
                name: `${u.user_firstname || ''} ${u.user_lastname || ''}`.trim() || u.username || (u.user_email || 'User'),
                email: u.user_email || '',
                role: (u.role || 'user').toLowerCase(),
                status: u.active === false ? 'suspended' : 'active',
                lastActive: new Date().toISOString(),
                avatar: 'https://randomuser.me/api/portraits/lego/1.jpg'
            }));
            currentUsers = [...sampleUsers];
        } catch (e) { console.error(e); }
    }

    function updateUserStats() {
        const stats = {
            active: currentUsers.filter(u => u.status === 'active').length,
            total: currentUsers.length,
            technician: currentUsers.filter(u => u.role === 'technician').length,
            office: currentUsers.filter(u => u.role === 'office').length
        };

        document.getElementById('active-users-count').textContent = stats.active;
        document.getElementById('total-users-count').textContent = stats.total;
        document.getElementById('technician-users-count').textContent = stats.technician;
        const offEl = document.getElementById('office-users-count');
        if (offEl) offEl.textContent = stats.office;
    }

    function renderUsersTable() {
        const tbody = document.getElementById('users-table-body');
        const emptyState = document.getElementById('users-empty-state');
        
        if (currentUsers.length === 0) {
            tbody.innerHTML = '';
            emptyState.style.display = 'block';
            return;
        }

        emptyState.style.display = 'none';
        
        tbody.innerHTML = currentUsers.map(user => `
            <tr data-user-id="${user.id}">
                <td>
                    <div class="user-cell">
                        <img src="${user.avatar}" alt="${user.name}" class="user-avatar">
                        <div class="user-info">
                            <div class="user-name">${user.name}</div>
                            <div class="user-email">${user.email}</div>
                        </div>
                    </div>
                </td>
                <td>
                    <span class="role-badge ${user.role}">
                        ${getRoleIcon(user.role)}
                        ${capitalizeFirst(user.role)}
                    </span>
                </td>
                <td>
                    <span class="status-badge ${user.status}">
                        <span class="status-dot ${user.status}"></span>
                        ${capitalizeFirst(user.status)}
                    </span>
                </td>
                <td>
                    <span class="last-active">${formatLastActive(user.lastActive)}</span>
                </td>
                <td>
                    <div class="user-actions">
                        <button class="action-btn edit" onclick="editUser(${user.id})" title="Edit User">
                            ‚úèÔ∏è Edit
                        </button>
                        <button class="action-btn ${user.status === 'suspended' ? 'unsuspend' : 'suspend'}" 
                                onclick="toggleUserStatus(${user.id})" 
                                title="${user.status === 'suspended' ? 'Unsuspend' : 'Suspend'} User">
                            ${user.status === 'suspended' ? '‚úÖ Unsuspend' : '‚õî Suspend'}
                        </button>
                        <button class="action-btn delete" onclick="deleteUser(${user.id})" title="Delete User">
                            üóëÔ∏è Delete
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    }

    function setupEventListeners() {
        // Search functionality
        const searchInput = document.getElementById('user-search');
        const roleFilter = document.getElementById('role-filter');
        const statusFilter = document.getElementById('status-filter');

        searchInput.addEventListener('input', filterUsers);
        roleFilter.addEventListener('change', filterUsers);
        statusFilter.addEventListener('change', filterUsers);

        // Refresh button
        document.getElementById('refresh-users').addEventListener('click', refreshUsers);

        // Table sorting
        document.querySelectorAll('.modern-users-table th.sortable').forEach(th => {
            th.addEventListener('click', () => sortTable(th.dataset.sort));
        });

        // Edit User modal controls
        const editModal = document.getElementById('edit-user-modal');
        const closeEditBtn = document.getElementById('close-edit-modal');
        const cancelEditBtn = editModal ? editModal.querySelector('.modal-btn.cancel') : null;
        const saveEditBtn = editModal ? editModal.querySelector('.modal-btn.save') : null;

        if (closeEditBtn) {
            closeEditBtn.addEventListener('click', closeEditModal);
        }
        if (cancelEditBtn) {
            cancelEditBtn.addEventListener('click', closeEditModal);
        }
        if (saveEditBtn) {
            saveEditBtn.addEventListener('click', saveEditedUser);
        }

        // Close edit modal on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && editModal && editModal.classList.contains('active')) {
                closeEditModal();
            }
        });
    }

    function filterUsers() {
        const searchTerm = document.getElementById('user-search').value.toLowerCase();
        const roleFilter = document.getElementById('role-filter').value;
        const statusFilter = document.getElementById('status-filter').value;

        currentUsers = sampleUsers.filter(user => {
            const matchesSearch = !searchTerm || 
                user.name.toLowerCase().includes(searchTerm) ||
                user.email.toLowerCase().includes(searchTerm);
            
            const matchesRole = !roleFilter || user.role === roleFilter;
            const matchesStatus = !statusFilter || user.status === statusFilter;

            return matchesSearch && matchesRole && matchesStatus;
        });

        updateUserStats();
        renderUsersTable();
    }

    function sortTable(field) {
        if (currentSort.field === field) {
            currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
            currentSort.field = field;
            currentSort.direction = 'asc';
        }

        currentUsers.sort((a, b) => {
            let aVal = a[field];
            let bVal = b[field];

            if (field === 'lastActive') {
                aVal = new Date(aVal);
                bVal = new Date(bVal);
            }

            if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
            if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
            return 0;
        });

        renderUsersTable();
        updateSortIndicators();
    }

    function updateSortIndicators() {
        document.querySelectorAll('.sort-indicator').forEach(indicator => {
            indicator.textContent = '‚Üï';
        });

        if (currentSort.field) {
            const th = document.querySelector(`[data-sort="${currentSort.field}"] .sort-indicator`);
            if (th) {
                th.textContent = currentSort.direction === 'asc' ? '‚Üë' : '‚Üì';
            }
        }
    }

    async function refreshUsers() {
        const loadingOverlay = document.getElementById('users-loading');
        loadingOverlay.style.display = 'flex';
        await fetchUsersFromDB();
        updateUserStats();
        renderUsersTable();
        loadingOverlay.style.display = 'none';
    }

    function editUser(userId) {
        const user = currentUsers.find(u => u.id === userId);
        if (user) {
            // Populate edit modal with user data
            document.getElementById('edit-user-firstname').value = user.name.split(' ')[0];
            document.getElementById('edit-user-lastname').value = user.name.split(' ')[1] || '';
            document.getElementById('edit-user-email').value = user.email;
            document.getElementById('edit-user-id').value = userId;
            
            // Show edit modal
            const modal = document.getElementById('edit-user-modal');
            modal.classList.add('active');
            modal.style.display = 'flex';
        }
    }

    async function toggleUserStatus(userId) {
        try {
            const client = window.supabaseClient || await waitForSupabaseClient(5000);
            if (!client) return alert('Supabase not initialized');
            const row = sampleUsers.find(u => u.id === userId);
            const newActive = row ? (row.status === 'suspended') : true;
            const { error } = await client
                .from('users')
                .update({ active: newActive })
                .eq('user_id', userId);
            if (error) { alert('Failed to update status: ' + error.message); return; }
            await refreshUsers();
        } catch (e) { console.error(e); alert('Unexpected error updating status'); }
    }

    async function deleteUser(userId) {
        if (!confirm('Delete this user? This cannot be undone unless your database uses soft-delete.')) return;
        try {
            const client = window.supabaseClient || await waitForSupabaseClient(5000);
            if (!client) return alert('Supabase not initialized');
            // Try hard delete
            const { error } = await client
                .from('users')
                .delete()
                .eq('user_id', userId);
            if (error) {
                console.warn('Hard delete failed, attempting soft-delete via update:', error);
                const { error: updErr } = await client
                    .from('users')
                    .update({ active: false })
                    .eq('user_id', userId);
                if (updErr) {
                    alert('Failed to delete user: ' + (updErr.message || error.message));
                    return;
                }
                alert('User deactivated (soft-deleted) due to database permissions.');
            }
            await refreshUsers();
        } catch (e) { console.error(e); alert('Unexpected error deleting user'); }
    }

    function closeEditModal() {
        const modal = document.getElementById('edit-user-modal');
        if (modal) {
            modal.classList.remove('active');
            modal.style.display = 'none';
        }
    }

    async function saveEditedUser() {
        const idInput = document.getElementById('edit-user-id');
        const firstNameInput = document.getElementById('edit-user-firstname');
        const lastNameInput = document.getElementById('edit-user-lastname');
        const emailInput = document.getElementById('edit-user-email');

        if (!idInput) return closeEditModal();

        const userId = parseInt(idInput.value, 10);
        const newFirst = (firstNameInput && firstNameInput.value || '').trim();
        const newLast = (lastNameInput && lastNameInput.value || '').trim();
        const newEmail = (emailInput && emailInput.value || '').trim();

        try {
            const client = window.supabaseClient || await waitForSupabaseClient(5000);
            if (!client) return alert('Supabase not initialized');
            const update = {};
            if (newFirst) update.user_firstname = newFirst;
            if (newLast) update.user_lastname = newLast;
            if (newEmail) update.user_email = newEmail;
            const { error } = await client
                .from('users')
                .update(update)
                .eq('user_id', userId);
            if (error) { alert('Failed to update user: ' + error.message); return; }
            await refreshUsers();
            closeEditModal();
        } catch (e) { console.error(e); alert('Unexpected error updating user'); }
    }

    // Helper functions
    function getRoleIcon(role) {
        const icons = {
            admin: '‚ö°',
            technician: 'üîß',
            user: 'üë§'
        };
        return icons[role] || 'üë§';
    }

    function capitalizeFirst(str) {
        return str.charAt(0).toUpperCase() + str.slice(1);
    }

    function formatLastActive(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffMs = now - date;
        const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
        const diffDays = Math.floor(diffHours / 24);

        if (diffHours < 1) return 'Just now';
        if (diffHours < 24) return `${diffHours}h ago`;
        if (diffDays < 7) return `${diffDays}d ago`;
        
        return date.toLocaleDateString();
    }

    // Make functions global for onclick handlers
    window.editUser = editUser;
    window.toggleUserStatus = toggleUserStatus;
    window.deleteUser = deleteUser;
    window.filterUsers = filterUsers;
    </script>

    <!-- Supabase and shared logic -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="app.js" defer></script>
</body>
</html>

<!-- Enhanced Account Settings Modal -->
<div id="account-settings-modal" class="ll-modal-overlay">
  <div class="ll-modal-card">
    <div>
      <h3>Account Settings</h3>
      <button id="account-settings-close" class="close-btn" aria-label="Close modal">&times;</button>
    </div>
    
    <div>
      <div class="ll-field">
        <label class="ll-label">Username</label>
        <input class="ll-input" id="acc-username" type="text" placeholder="Enter username" />
      </div>
      
      <div class="ll-field">
        <label class="ll-label">First Name</label>
        <input class="ll-input" id="acc-firstname" type="text" placeholder="Enter first name" />
      </div>
      
      <div class="ll-field">
        <label class="ll-label">Last Name</label>
        <input class="ll-input" id="acc-lastname" type="text" placeholder="Enter last name" />
      </div>
      
      <div class="ll-field">
        <label class="ll-label">Email Address</label>
        <input class="ll-input" id="acc-email" type="email" placeholder="Enter email address" />
      </div>
      
      <div class="ll-field">
        <label class="ll-label">New Password</label>
        <input class="ll-input" id="acc-newpwd" type="password" placeholder="Enter new password" autocomplete="new-password" />
      </div>
      
      <div class="ll-field">
        <label class="ll-label">Current Password</label>
        <input class="ll-input" id="acc-currpwd" type="password" placeholder="Enter current password" autocomplete="current-password" />
      </div>
    </div>
    
    <div class="ll-actions">
      <button class="ll-btn" id="account-settings-cancel">Cancel</button>
      <button class="ll-btn-primary" id="account-settings-save">Save Changes</button>
    </div>
  </div>
</div>


